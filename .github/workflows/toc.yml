name: Auto TOC

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-toc:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate README TOC after title page
        run: |
          python - <<'PY'
          import re
          from pathlib import Path

          path = Path("README.md")
          lines = path.read_text().splitlines()

          start_marker = "<!-- START doctoc generated TOC please keep comment here to allow auto update -->"
          end_marker = "<!-- END doctoc generated TOC please keep comment here to allow auto update -->"

          try:
            start_idx = lines.index(start_marker)
            end_idx = lines.index(end_marker)
          except ValueError as exc:
            raise SystemExit(f"TOC markers missing: {exc}")
          if start_idx >= end_idx:
            raise SystemExit("TOC markers are out of order.")

          def slugify(text: str) -> str:
            text = text.lower().strip()
            text = re.sub(r"[`*_~]", "", text)
            text = re.sub(r"[^0-9a-z\\s-]", "", text)
            text = re.sub(r"\\s+", "-", text)
            text = re.sub(r"-+", "-", text)
            return text.strip("-")

          toc_lines = ["## Index", ""]
          in_code = False
          for i, line in enumerate(lines):
            if start_idx <= i <= end_idx:
              continue
            if line.strip().startswith("```"):
              in_code = not in_code
              continue
            if in_code:
              continue
            match = re.match(r"^(#{1,6})\\s+(.*)", line)
            if not match:
              continue
            level = len(match.group(1))
            if level > 3:
              continue
            title = match.group(2).strip()
            anchor = slugify(title)
            indent = "  " * (level - 1)
            toc_lines.append(f"{indent}- [{title}](#{anchor})")

          new_lines = lines[: start_idx + 1] + toc_lines + [lines[end_idx]] + lines[end_idx + 1 :]
          if new_lines != lines:
            path.write_text("\n".join(new_lines) + "\n")
          PY

      - name: Commit TOC update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update README TOC"
          file_pattern: README.md
